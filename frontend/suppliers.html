<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMS - Suppliers</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <h1>Grocery Management System</h1>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="pos.html">POS</a></li>
                    <li><a href="suppliers.html">Suppliers</a></li>
                    <li><a href="reports.html">Reports</a></li>
                    <li><button onclick="Auth.logout()" class="logout-btn">Logout</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <h2>Supplier Management</h2>
            <button onclick="openModal()">Add Supplier</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Contact Person</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="supplierTableBody">
                    <!-- Suppliers will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Add/Edit Supplier -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add Supplier</h2>
            <form id="supplierForm">
                <input type="hidden" id="supplierId">
                <div class="form-group">
                    <label for="name">Supplier Name</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="contact_person">Contact Person</label>
                    <input type="text" id="contact_person" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="text" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address"></textarea>
                </div>
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        Auth.requireAuth();

        const supplierTableBody = document.getElementById('supplierTableBody');
        const supplierModal = document.getElementById('supplierModal');
        const supplierForm = document.getElementById('supplierForm');
        const modalTitle = document.getElementById('modalTitle');

        // Load Suppliers
        async function loadSuppliers() {
            try {
                const suppliers = await Api.get('/suppliers');
                supplierTableBody.innerHTML = suppliers.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.contact_person}</td>
                        <td>${s.email}</td>
                        <td>${s.phone}</td>
                        <td class="actions">
                            <button class="secondary" onclick="editSupplier(${s.id})">Edit</button>
                            <button class="danger" onclick="deleteSupplier(${s.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error(error);
                alert('Failed to load suppliers');
            }
        }

        loadSuppliers();

        // Modal Functions
        function openModal() {
            supplierModal.style.display = 'block';
            modalTitle.textContent = 'Add Supplier';
            supplierForm.reset();
            document.getElementById('supplierId').value = '';
        }

        function closeModal() {
            supplierModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == supplierModal) {
                closeModal();
            }
        }

        // Add/Edit Supplier
        supplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('supplierId').value;
            const data = {
                name: document.getElementById('name').value,
                contact_person: document.getElementById('contact_person').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };

            try {
                if (id) {
                    await Api.put(`/suppliers/${id}`, data);
                } else {
                    await Api.post('/suppliers', data);
                }
                closeModal();
                loadSuppliers();
            } catch (error) {
                alert(error.message);
            }
        });

        // Edit Supplier
        async function editSupplier(id) {
            try {
                const supplier = await Api.get(`/suppliers/${id}`);
                document.getElementById('supplierId').value = supplier.id;
                document.getElementById('name').value = supplier.name;
                document.getElementById('contact_person').value = supplier.contact_person;
                document.getElementById('email').value = supplier.email;
                document.getElementById('phone').value = supplier.phone;
                document.getElementById('address').value = supplier.address || '';

                modalTitle.textContent = 'Edit Supplier';
                supplierModal.style.display = 'block';
            } catch (error) {
                alert('Failed to fetch supplier details');
            }
        }

        // Delete Supplier
        async function deleteSupplier(id) {
            if (confirm('Are you sure you want to delete this supplier?')) {
                try {
                    await Api.delete(`/suppliers/${id}`);
                    loadSuppliers();
                } catch (error) {
                    alert(error.message);
                }
            }
        }
    </script>
</body>
</html>
