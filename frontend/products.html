<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMS - Products</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <h1>Grocery Management System</h1>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="pos.html">POS</a></li>
                    <li><a href="suppliers.html">Suppliers</a></li>
                    <li><a href="reports.html">Reports</a></li>
                    <li><button onclick="Auth.logout()" class="logout-btn">Logout</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <h2>Product Management</h2>
            <button onclick="openModal()">Add Product</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Add/Edit Product -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add Product</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="name">Product Name</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <input type="text" id="category" required>
                </div>
                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="number" id="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="stock_quantity">Stock Quantity</label>
                    <input type="number" id="stock_quantity" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="sku">SKU</label>
                    <input type="text" id="sku">
                </div>
                <!-- Image upload could be added here -->
                <button type="submit">Save</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        Auth.requireAuth();

        const productTableBody = document.getElementById('productTableBody');
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const modalTitle = document.getElementById('modalTitle');

        // Load Products
        async function loadProducts() {
            try {
                const products = await Api.get('/products');
                productTableBody.innerHTML = products.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.category}</td>
                        <td>$${p.price}</td>
                        <td>${p.stock_quantity}</td>
                        <td class="actions">
                            <button class="secondary" onclick="editProduct(${p.id})">Edit</button>
                            <button class="danger" onclick="deleteProduct(${p.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error(error);
                alert('Failed to load products');
            }
        }

        loadProducts();

        // Modal Functions
        function openModal() {
            productModal.style.display = 'block';
            modalTitle.textContent = 'Add Product';
            productForm.reset();
            document.getElementById('productId').value = '';
        }

        function closeModal() {
            productModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == productModal) {
                closeModal();
            }
        }

        // Add/Edit Product
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                price: document.getElementById('price').value,
                stock_quantity: document.getElementById('stock_quantity').value,
                description: document.getElementById('description').value,
                sku: document.getElementById('sku').value
            };

            try {
                if (id) {
                    await Api.put(`/products/update/${id}`, data);
                } else {
                    await Api.post('/products/add', data);
                }
                closeModal();
                loadProducts();
            } catch (error) {
                alert(error.message);
            }
        });

        // Edit Product
        async function editProduct(id) {
            try {
                const product = await Api.get(`/products/${id}`);
                document.getElementById('productId').value = product.id;
                document.getElementById('name').value = product.name;
                document.getElementById('category').value = product.category;
                document.getElementById('price').value = product.price;
                document.getElementById('stock_quantity').value = product.stock_quantity;
                document.getElementById('description').value = product.description || '';
                document.getElementById('sku').value = product.sku || '';

                modalTitle.textContent = 'Edit Product';
                productModal.style.display = 'block';
            } catch (error) {
                alert('Failed to fetch product details');
            }
        }

        // Delete Product
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await Api.delete(`/products/delete/${id}`);
                    loadProducts();
                } catch (error) {
                    alert(error.message);
                }
            }
        }
    </script>
</body>
</html>
